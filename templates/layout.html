<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}Chakra X{% endblock %}</title>

    <!-- ‚úÖ Tailwind & Bootstrap -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- ‚úÖ Charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- ‚úÖ TensorFlow & Teachable Machine (Correct Order, Only Once) -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.9.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

    <style>
      /* Floating webcam styling */
      #webcam-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 180px;
        height: 135px;
        border: 3px solid #00ff7f; /* Green = Normal */
        border-radius: 12px;
        overflow: hidden;
        background: rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(5px);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        z-index: 9999;
        cursor: grab;
      }

      #webcam-container.dragging {
        opacity: 0.8;
        cursor: grabbing;
      }

      #minimize-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        background: rgba(255, 255, 255, 0.7);
        border: none;
        border-radius: 4px;
        font-size: 12px;
        cursor: pointer;
        z-index: 10000;
      }

      #label-container {
        display: none;
      }

      #webcam-container:hover {
        transform: scale(1.05);
        border-color: #03a9f4;
      }
    </style>

    <script>
    const URL = "/static/model/";
    let model, webcam, labelContainer, maxPredictions;
    let confusedCounter = 0, chatbotCooldown = false;
    let webcamContainer = null;

    async function initConfusionDetector() {
        const modelURL = URL + "model.json";
        const metadataURL = URL + "metadata.json";

        model = await tmImage.load(modelURL, metadataURL);
        maxPredictions = model.getTotalClasses();

        const flip = true;
        webcam = new tmImage.Webcam(180, 135, flip);
        await webcam.setup();
        await webcam.play();
        window.requestAnimationFrame(loop);

        webcamContainer = document.getElementById("webcam-container");
        webcamContainer.appendChild(webcam.canvas);

        makeDraggable(webcamContainer);
        document.getElementById("minimize-btn").addEventListener("click", toggleMinimize);

        labelContainer = document.getElementById("label-container");
    }

    async function loop() {
        webcam.update();
        await predict();
        window.requestAnimationFrame(loop);
    }

    async function predict() {
        const prediction = await model.predict(webcam.canvas);
        let confusedProb = 0;

        prediction.forEach(pred => {
            if (pred.className === "Confused") confusedProb = pred.probability;
        });

        console.log("Confused Prob:", confusedProb.toFixed(2), "Counter:", confusedCounter);

        if (!chatbotCooldown) {
            if (confusedProb > 0.98) {
                confusedCounter++;
                webcamContainer.style.borderColor = "#ff4c4c"; // Red = Confused
                if (confusedCounter > 65) {
                    triggerChatbot();
                    confusedCounter = 0;
                    chatbotCooldown = true;
                    setTimeout(() => chatbotCooldown = false, 20000);
                }
            } else {
                webcamContainer.style.borderColor = "#00ff7f"; // Green = Normal
                if (confusedProb < 0.6) confusedCounter = 0;
            }
        }
    }

    function triggerChatbot() {
        console.log("ü§ñ Confusion Detected! Triggering Chatbot...");
        speak("We noticed you might need help, opening support‚Ä¶");
        // TODO: Auto-open chatbot function here
    }

    function speak(text) {
        const utterance = new SpeechSynthesisUtterance(text);
        speechSynthesis.speak(utterance);
    }

    // ‚úÖ Draggable Webcam
    function makeDraggable(el) {
        let isDragging = false, offsetX, offsetY;

        el.addEventListener("mousedown", (e) => {
            isDragging = true;
            offsetX = e.clientX - el.getBoundingClientRect().left;
            offsetY = e.clientY - el.getBoundingClientRect().top;
            el.classList.add("dragging");
        });

        document.addEventListener("mousemove", (e) => {
            if (!isDragging) return;
            el.style.left = (e.clientX - offsetX) + "px";
            el.style.top = (e.clientY - offsetY) + "px";
            el.style.right = "auto"; el.style.bottom = "auto";
        });

        document.addEventListener("mouseup", () => {
            isDragging = false;
            el.classList.remove("dragging");
        });
    }

    // ‚úÖ Minimize Button
    function toggleMinimize() {
        if (webcam.canvas.style.display === "none") {
            webcam.canvas.style.display = "block";
            this.textContent = "‚Äì";
        } else {
            webcam.canvas.style.display = "none";
            this.textContent = "+";
        }
    }

    document.addEventListener("DOMContentLoaded", initConfusionDetector);
</script>

  </head>

  <body
    class="min-h-screen bg-[#E9ECF0] bg-gradient-to-tr from-[#e6e6e6] to-[#f4f4f4] text-gray-800"
  >
    <!-- Navbar -->
    <nav
      class="bg-white/40 backdrop-blur-md border-b border-gray-200 px-6 py-4 flex justify-between items-center shadow-md"
    >
      <h1 class="text-xl font-bold text-blue-600">üîê Chakra X</h1>
      <div class="space-x-4">
        {% if user.is_authenticated %}
        <span class="text-sm">Welcome, {{ user.username }}</span>
        <a
          href="{% url 'logout' %}"
          class="text-blue-600 hover:underline text-sm"
          >Logout</a
        >
        {% else %}
        <a
          href="{% url 'login' %}"
          class="text-blue-600 hover:underline text-sm"
          >Login</a
        >
        <a
          href="{% url 'signup' %}"
          class="text-blue-600 hover:underline text-sm"
          >Sign Up</a
        >
        {% endif %}
      </div>
    </nav>

    <!-- Webcam -->
    <div id="webcam-container">
    <button id="minimize-btn">‚Äì</button>
</div>
<div id="label-container"></div>


    <!-- Main Content -->
    <main class="p-6">{% block content %}{% endblock %}</main>
  </body>
</html>
