<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}Chakra X{% endblock %}</title>

    <!-- ‚úÖ Tailwind & Bootstrap -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- ‚úÖ Charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- ‚úÖ TensorFlow & Teachable Machine (Correct Order, Only Once) -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.9.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

    <style>
      /* Floating webcam styling */
      #webcam-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 180px;
        height: 135px;
        border: 2px solid #00bcd4;
        border-radius: 12px;
        overflow: hidden;
        background: rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(5px);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        z-index: 9999;
        transition: all 0.3s ease-in-out;
      }

      #webcam-container:hover {
        transform: scale(1.05);
        border-color: #03a9f4;
      }

      #label-container {
        display: none;
      }
    </style>

    <script>
      const URL = "/static/model/";
      let model, webcam, labelContainer, maxPredictions;
      let confusedCounter = 0;
      let chatbotCooldown = false;

      async function initConfusionDetector() {
        try {
          const modelURL = URL + "model.json";
          const metadataURL = URL + "metadata.json";

          model = await tmImage.load(modelURL, metadataURL);
          maxPredictions = model.getTotalClasses();

          const flip = true;
          webcam = new tmImage.Webcam(180, 135, flip);
          await webcam.setup();
          await webcam.play();
          window.requestAnimationFrame(loop);

          document
            .getElementById("webcam-container")
            .appendChild(webcam.canvas);
          labelContainer = document.getElementById("label-container");

          console.log("‚úÖ Confusion Detector Initialized");
        } catch (err) {
          console.error("‚ùå Error initializing confusion detector:", err);
        }
      }

      async function loop() {
        webcam.update();
        await predict();
        window.requestAnimationFrame(loop);
      }

      async function predict() {
        const prediction = await model.predict(webcam.canvas);
        let confusedProb = 0;

        prediction.forEach((pred) => {
          if (pred.className === "Confused") {
            confusedProb = pred.probability;
          }
        });

        console.log(
          "Confused Prob:",
          confusedProb.toFixed(2),
          "Counter:",
          confusedCounter
        );

        if (!chatbotCooldown) {
          if (confusedProb > 0.94) {
            // Slightly easier to trigger
            confusedCounter++;
            if (confusedCounter > 50) {
              // ~1.2 sec continuous confusion
              triggerChatbot();
              confusedCounter = 0;
              chatbotCooldown = true;
              setTimeout(() => (chatbotCooldown = false), 20000);
            }
          } else if (confusedProb < 0.6) {
            // Reset faster when normal
            confusedCounter = 0;
          }
        }
      }

      function triggerChatbot() {
        console.log("ü§ñ Confusion Detected! Triggering Chatbot...");
        speak("We noticed you might need help, opening support‚Ä¶");
        // ‚úÖ Later ‚Üí auto-open chatbot here
      }

      function speak(text) {
        const utterance = new SpeechSynthesisUtterance(text);
        speechSynthesis.speak(utterance);
      }

      document.addEventListener("DOMContentLoaded", initConfusionDetector);
    </script>
  </head>

  <body
    class="min-h-screen bg-[#E9ECF0] bg-gradient-to-tr from-[#e6e6e6] to-[#f4f4f4] text-gray-800"
  >
    <!-- Navbar -->
    <nav
      class="bg-white/40 backdrop-blur-md border-b border-gray-200 px-6 py-4 flex justify-between items-center shadow-md"
    >
      <h1 class="text-xl font-bold text-blue-600">üîê Chakra X</h1>
      <div class="space-x-4">
        {% if user.is_authenticated %}
        <span class="text-sm">Welcome, {{ user.username }}</span>
        <a
          href="{% url 'logout' %}"
          class="text-blue-600 hover:underline text-sm"
          >Logout</a
        >
        {% else %}
        <a
          href="{% url 'login' %}"
          class="text-blue-600 hover:underline text-sm"
          >Login</a
        >
        <a
          href="{% url 'signup' %}"
          class="text-blue-600 hover:underline text-sm"
          >Sign Up</a
        >
        {% endif %}
      </div>
    </nav>

    <!-- Webcam -->
    <div id="webcam-container"></div>
    <div id="label-container"></div>

    <!-- Main Content -->
    <main class="p-6">{% block content %}{% endblock %}</main>
  </body>
</html>
